#!/bin/sh -eu

# Control script for the running eyes daemon

show_usage() {
    echo "Usage: $0 {show|stop|status}"
    echo ""
    echo "Commands:"
    echo "  show   - Show immediate eye break reminder"
    echo "  stop   - Stop the running daemon"
    echo "  status - Check if daemon is running"
    exit 1
}

get_eyes_pid() {
    # Get PID from launchctl or fallback to pgrep
    PID=$(launchctl list | grep com.eyes | awk '{print $1}' 2>/dev/null || echo "")
    if [ -z "$PID" ] || [ "$PID" = "-" ]; then
        PID=$(pgrep -f "eyes.*--interval" 2>/dev/null || echo "")
    fi
    echo "$PID"
}

case "${1:-}" in
    show)
        PID=$(get_eyes_pid)
        if [ -n "$PID" ]; then
            echo "Sending show reminder signal to PID $PID..."
            kill -USR1 "$PID"
        else
            echo "Eyes daemon not running"
            exit 1
        fi
        ;;
    stop)
        PID=$(get_eyes_pid)
        if [ -n "$PID" ]; then
            echo "Stopping eyes daemon (PID $PID)..."
            kill -TERM "$PID"
        else
            echo "Eyes daemon not running"
            exit 1
        fi
        ;;
    status)
        PID=$(get_eyes_pid)
        if [ -n "$PID" ]; then
            echo "Eyes daemon running (PID $PID)"
        else
            echo "Eyes daemon not running"
            exit 1
        fi
        ;;
    *)
        show_usage
        ;;
esac